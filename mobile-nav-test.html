<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Nav Slide + Fade Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        /* Desktop header */
        .header {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        [data-nav-toggle] {
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-open-img {
            display: block;
        }

        .nav-close-img {
            display: none;
        }

        [data-nav-toggle][aria-expanded="true"] .nav-open-img {
            display: none;
        }

        [data-nav-toggle][aria-expanded="true"] .nav-close-img {
            display: block;
        }

        /* Mobile nav overlay */
        [data-nav-mobile] {
            display: none;
        }

        [data-nav-mobile].ff-nav-mobile--open {
            display: block;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            height: 100vh;
            z-index: 1;
            background: rgba(0, 0, 0, 0.5);
        }

        .ff-nav-mobile__track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            background: #fff;
            overflow: hidden;
        }

        /* Panels */
        .ff-nav-mobile__panel {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateX(0);
            pointer-events: none;
            transition: opacity 200ms ease-out, transform 200ms ease-out;
            will-change: opacity, transform;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: #fff;
            padding: 16px;
            z-index: 1;
        }

        .ff-nav-mobile__panel.ff-nav-mobile__panel--active {
            opacity: 1;
            pointer-events: auto;
            z-index: 2;
        }

        /* Directional slide classes */
        .ff-nav-mobile__panel--enter-right {
            transform: translateX(50%);
            z-index: 2;
        }

        .ff-nav-mobile__panel--enter-left {
            transform: translateX(-50%);
            z-index: 2;
        }

        .ff-nav-mobile__panel--exit-left {
            transform: translateX(-50%);
        }

        .ff-nav-mobile__panel--exit-right {
            transform: translateX(50%);
        }

        /* Panel content */
        .ff-nav-mobile__panel h2 {
            margin-bottom: 16px;
            font-size: 18px;
            color: #333;
        }

        .ff-nav-mobile__panel-list {
            list-style: none;
        }

        .ff-nav-mobile__panel-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .ff-nav-mobile__panel-item a {
            color: #0066cc;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ff-nav-mobile__panel-item a:hover {
            color: #0052a3;
        }

        /* Chrome header (layer 2+) */
        .ff-nav-mobile__chrome {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #fff;
            z-index: 10;
            display: none;
            border-bottom: 1px solid #ddd;
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
        }

        [data-nav-mobile].ff-nav-mobile--chrome-on .ff-nav-mobile__chrome {
            display: flex;
        }

        .ff-nav-mobile__chrome-back,
        .ff-nav-mobile__chrome-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -10px;
        }

        .ff-nav-mobile__chrome-title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .ff-nav-mobile__panel {
                transition: opacity 200ms ease-out;
                transform: translateX(0) !important;
            }

            .ff-nav-mobile__panel--enter-right,
            .ff-nav-mobile__panel--enter-left,
            .ff-nav-mobile__panel--exit-right,
            .ff-nav-mobile__panel--exit-left {
                transform: translateX(0) !important;
            }
        }

        /* Main content */
        .content {
            padding: 20px;
            background: white;
            margin: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .content h1 {
            margin-bottom: 12px;
            color: #333;
        }

        .content p {
            color: #666;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1 class="header-title">Navigation Test</h1>
        <button data-nav-toggle aria-expanded="false" aria-label="Open primary navigation">
            <span class="nav-open-img">☰</span>
            <span class="nav-close-img">✕</span>
        </button>
    </div>

    <!-- Mobile Nav -->
    <div data-nav-mobile>
        <div class="ff-nav-mobile__track">
            <!-- Chrome header (shows on layer 2+) -->
            <div class="ff-nav-mobile__chrome">
                <button class="ff-nav-mobile__chrome-back" data-mobile-chrome-back>←</button>
                <div class="ff-nav-mobile__chrome-title" data-mobile-chrome-title></div>
                <button class="ff-nav-mobile__chrome-close" data-mobile-chrome-close>✕</button>
            </div>

            <!-- Root panel -->
            <div data-mobile-panel="root" class="ff-nav-mobile__panel">
                <h2>Main Menu</h2>
                <ul class="ff-nav-mobile__panel-list">
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#" data-mobile-target="solutions" data-panel-title="Solutions">
                            Solutions <span>→</span>
                        </a>
                    </li>
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#" data-mobile-target="products" data-panel-title="Products">
                            Products <span>→</span>
                        </a>
                    </li>
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#contact">Contact</a>
                    </li>
                </ul>
            </div>

            <!-- Solutions submenu -->
            <div data-mobile-panel="solutions" data-panel-parent="root" class="ff-nav-mobile__panel">
                <h2>Solutions</h2>
                <ul class="ff-nav-mobile__panel-list">
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#" data-mobile-target="enterprise" data-panel-title="Enterprise">
                            Enterprise <span>→</span>
                        </a>
                    </li>
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#" data-mobile-target="smb" data-panel-title="Small Business">
                            Small Business <span>→</span>
                        </a>
                    </li>
                    <li class="ff-nav-mobile__panel-item">
                        <a href="#solutions-all">View All Solutions</a>
                    </li>
                </ul>
            </div>

            <!-- Enterprise submenu -->
            <div data-mobile-panel="enterprise" data-panel-parent="solutions" class="ff-nav-mobile__panel">
                <h2>Enterprise</h2>
                <ul class="ff-nav-mobile__panel-list">
                    <li class="ff-nav-mobile__panel-item"><a href="#enterprise-1">Large Scale Deployments</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#enterprise-2">Dedicated Support</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#enterprise-3">Custom Integration</a></li>
                </ul>
            </div>

            <!-- SMB submenu -->
            <div data-mobile-panel="smb" data-panel-parent="solutions" class="ff-nav-mobile__panel">
                <h2>Small Business</h2>
                <ul class="ff-nav-mobile__panel-list">
                    <li class="ff-nav-mobile__panel-item"><a href="#smb-1">Starter Plan</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#smb-2">Growth Plan</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#smb-3">Premium Plan</a></li>
                </ul>
            </div>

            <!-- Products submenu -->
            <div data-mobile-panel="products" data-panel-parent="root" class="ff-nav-mobile__panel">
                <h2>Products</h2>
                <ul class="ff-nav-mobile__panel-list">
                    <li class="ff-nav-mobile__panel-item"><a href="#product-1">Product A</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#product-2">Product B</a></li>
                    <li class="ff-nav-mobile__panel-item"><a href="#product-3">Product C</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="content">
        <h1>Slide + Fade Mobile Nav Test</h1>
        <p>Click the hamburger menu (☰) to open the mobile navigation. Test the transitions:</p>
        <ul style="margin: 12px 0 0 20px; color: #666; line-height: 1.8;">
            <li><strong>Forward:</strong> Click "Solutions" → should slide from right with fade</li>
            <li><strong>Forward again:</strong> Click "Enterprise" → should slide from right with fade</li>
            <li><strong>Backward:</strong> Click back arrow → should slide from left with fade</li>
            <li><strong>Rapid clicking:</strong> Try clicking multiple times quickly → no glitches</li>
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mobileRoot = document.querySelector('[data-nav-mobile]');
            const toggleBtn = document.querySelector('[data-nav-toggle]');
            if (!mobileRoot || !toggleBtn) return;

            const panels = Array.from(mobileRoot.querySelectorAll('[data-mobile-panel]'));
            if (!panels.length) return;

            const panelByKey = new Map();
            panels.forEach(p => panelByKey.set(p.getAttribute('data-mobile-panel'), p));

            const chromeTitleEl = mobileRoot.querySelector('[data-mobile-chrome-title]');

            let isOpen = false;
            let currentKey = 'root';
            let lastFocus = null;

            function syncChrome(){
                const isSub = currentKey !== 'root';
                mobileRoot.classList.toggle('ff-nav-mobile--chrome-on', isSub);
                if (chromeTitleEl) chromeTitleEl.textContent = isSub ? (panelByKey.get(currentKey)?.dataset.panelTitle?.trim() || '') : '';
            }

            function setAria() {
                toggleBtn.setAttribute('aria-expanded', String(isOpen));
            }

            function setActive(key, direction = null) {
                const prev = panelByKey.get(currentKey);
                const next = panelByKey.get(key) || panelByKey.get('root');

                if (!next || currentKey === key) return;

                currentKey = key;

                // If no direction specified, simple opacity fade
                if (!direction) {
                    panels.forEach(p => p.classList.remove('ff-nav-mobile__panel--active'));
                    if (next) next.classList.add('ff-nav-mobile__panel--active');
                    syncChrome();
                    console.log(`Panel change (fade only): ${key}`);
                    return;
                }

                // Two-phase slide + fade transition
                console.log(`Panel change (${direction}): ${key}`);
                requestAnimationFrame(() => {
                    // Phase 1: Set up initial states
                    panels.forEach(p => p.classList.remove('ff-nav-mobile__panel--active'));
                    panels.forEach(p => {
                        p.classList.remove(
                            'ff-nav-mobile__panel--enter-right',
                            'ff-nav-mobile__panel--enter-left',
                            'ff-nav-mobile__panel--exit-right',
                            'ff-nav-mobile__panel--exit-left'
                        );
                    });

                    if (direction === 'forward') {
                        next.classList.add('ff-nav-mobile__panel--enter-right');
                        if (prev) prev.classList.add('ff-nav-mobile__panel--exit-left');
                    } else if (direction === 'backward') {
                        next.classList.add('ff-nav-mobile__panel--enter-left');
                        if (prev) prev.classList.add('ff-nav-mobile__panel--exit-right');
                    }

                    // Phase 2: Trigger transition
                    requestAnimationFrame(() => {
                        next.classList.add('ff-nav-mobile__panel--active');
                        next.classList.remove('ff-nav-mobile__panel--enter-right', 'ff-nav-mobile__panel--enter-left');

                        if (prev) {
                            setTimeout(() => {
                                prev.classList.remove('ff-nav-mobile__panel--exit-left', 'ff-nav-mobile__panel--exit-right');
                            }, 200);
                        }
                    });
                });

                syncChrome();
            }

            function openMenu() {
                lastFocus = document.activeElement;
                isOpen = true;
                mobileRoot.classList.add('ff-nav-mobile--open');
                document.body.style.overflow = 'hidden';
                setActive('root');
                setAria();
            }

            function closeMenu() {
                isOpen = false;
                mobileRoot.classList.remove('ff-nav-mobile--open', 'ff-nav-mobile--chrome-on');
                document.body.style.overflow = '';
                panels.forEach(p => p.classList.remove('ff-nav-mobile__panel--active'));
                setAria();
                if (lastFocus?.focus) lastFocus.focus();
            }

            function goTo(key) {
                if (!panelByKey.has(key)) return;
                setActive(key, 'forward');
            }

            function goBack() {
                const panel = panelByKey.get(currentKey);
                const parent = panel?.dataset.panelParent || 'root';
                setActive(parent, 'backward');
            }

            closeMenu();

            toggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                isOpen ? closeMenu() : openMenu();
            });

            // Handle all link clicks in nav
            mobileRoot.addEventListener('click', (e) => {
                if (!isOpen) return;

                // Backdrop click closes menu
                if (e.target === mobileRoot) {
                    closeMenu();
                    return;
                }

                // Handle back button
                const backBtn = e.target.closest('[data-mobile-chrome-back]');
                if (backBtn) {
                    e.preventDefault();
                    goBack();
                    return;
                }

                // Handle close button
                const closeBtn = e.target.closest('[data-mobile-chrome-close]');
                if (closeBtn) {
                    e.preventDefault();
                    closeMenu();
                    return;
                }

                // Handle navigation links
                const link = e.target.closest('a');
                if (!link) return;

                const target = link.getAttribute('data-mobile-target');
                if (target) {
                    e.preventDefault();
                    goTo(target);
                }
            });

            // Log transitions
            console.log('Mobile nav initialized with slide+fade transitions');
        });
    </script>
</body>
</html>
